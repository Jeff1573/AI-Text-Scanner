# 开机自启修复说明

## 问题描述
打包后的应用无法正常设置开机自启，设置不生效。

## 根本原因
1. **路径检测策略不当**：原有策略优先级不正确，没有优先使用 Squirrel 的 Update.exe 方式
2. **验证机制不完善**：设置后没有充分验证是否真正生效
3. **清理逻辑缺失**：禁用时没有清除所有可能的注册表项

## 修复内容

### 1. 主进程修复 (`main/managers/ipcHandlers.ts`)
- **优化策略优先级**：将 `Squirrel Update.exe` 方式设为最高优先级
- **改进参数格式**：修正 Update.exe 的启动参数格式
- **增强验证机制**：设置后立即验证是否生效
- **完善清理逻辑**：禁用时清除所有策略的设置

### 2. 验证工具修复 (`main/utils/autoLaunchValidator.ts`)
- **统一策略顺序**：与设置逻辑保持一致的策略优先级
- **改进参数格式**：统一使用正确的参数格式

### 3. 前端逻辑修复 (`renderer/src/hooks/useAutoLaunch.ts`)
- **增强错误处理**：更详细的错误信息和状态检查
- **改进验证逻辑**：使用新的 `verified` 字段确认设置成功

### 4. 设置页面修复 (`renderer/src/hooks/useSettingsLogic.ts`)
- **独立处理开机自启**：将开机自启设置从普通配置中分离
- **增强错误反馈**：提供更准确的错误提示

### 5. 类型定义更新
- **完善 API 类型**：添加 `verified` 字段和相关类型
- **统一配置类型**：确保所有地方的配置类型一致

## 修复后的工作流程

### 设置开机自启
1. 检测可用的启动策略（优先 Update.exe）
2. 如果是禁用操作，先清除所有策略的设置
3. 使用选定策略设置开机自启
4. 立即验证设置是否生效
5. 返回验证结果给前端

### 获取开机自启状态
1. 按优先级检查所有策略
2. 找到第一个已启用的策略
3. 如果没有启用的策略，使用第一个可用策略检查状态
4. 返回详细的状态信息

## 策略优先级（Windows）
1. **Squirrel Update.exe** - 推荐用于打包应用
   - 路径: `../Update.exe`
   - 参数: `['--processStart', 'app.exe']`
2. **Squirrel Standard** - 标准启动器
   - 路径: `../app.exe`
   - 参数: 无
3. **Direct Executable** - 直接可执行文件（开发环境）
   - 路径: 当前进程路径
   - 参数: 无

## 测试方法
1. 运行 `npm run make` 打包应用
2. 安装打包后的应用
3. 在设置页面测试开机自启开关
4. 重启系统验证是否自动启动

## 调试工具
- 使用 `validateAutoLaunch` API 获取详细诊断信息
- 使用 `getAutoLaunchDiagnostics` API 获取完整报告
- 查看控制台日志了解策略选择过程