# 系统托盘功能实现总结

## 概述
本文档总结了在Electron应用中实现系统托盘功能的完整过程，包括主进程配置、渲染进程集成、状态管理等方面。

## 技术栈
- **Electron**: 主进程和渲染进程架构
- **React**: 前端UI框架
- **TypeScript**: 类型安全
- **Context API**: 状态管理

## 核心实现

### 1. 主进程配置 (`main/main.ts`)

#### 托盘创建
```typescript
// 创建系统托盘
const createTray = () => {
  // 使用base64编码的PNG图标
  const icon = nativeImage.createFromDataURL('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAbwAAAG8B8aLcQwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3Njape.org5vuPBoAAAB9SURBVDiNY2AYBaNg4AEGBgaG/0wMDP8ZGBj+MzAw/GdkYPjPxMDwn4mB4T8jA8N/JgaG/4wMDP+ZGBj+MzEw/GdiYPjPxMDwn4mB4T8TA8N/JgaG/0wMDP+ZGBj+MzEw/GdiYPjPxMDwn4mB4T8TA8N/JgaG/0wMDP+ZGBj+MzEw/GcAABqgBQABjF8YAAAAAElFTkSuQmCC');
  
  // 创建托盘实例
  tray = new Tray(icon);
  tray.setToolTip('AI Text Scanner - AI文字识别工具');
  
  // 创建托盘菜单
  const contextMenu = Menu.buildFromTemplate([
    { label: '显示主窗口', click: () => { /* ... */ } },
    { label: '截图识别', accelerator: 'CmdOrCtrl+Shift+S', click: async () => { /* ... */ } },
    { label: '历史记录', accelerator: 'CmdOrCtrl+Shift+R', click: () => { /* ... */ } },
    { type: 'separator' },
    { label: '设置', click: () => { /* ... */ } },
    { type: 'separator' },
    { label: '退出', click: () => { app.quit(); } }
  ]);
  
  tray.setContextMenu(contextMenu);
  
  // 托盘图标点击事件
  tray.on('click', () => { /* ... */ });
  tray.on('double-click', () => { /* ... */ });
};
```

#### 窗口管理策略
```typescript
// 当所有窗口关闭时，不退出应用，而是隐藏到托盘
app.on("window-all-closed", () => {
  if (process.platform !== "darwin") {
    return; // 不调用app.quit()，让应用继续在托盘中运行
  }
});
```

#### IPC处理器
```typescript
// 托盘相关IPC处理器
ipcMain.handle("hide-to-tray", (event) => {
  const win = BrowserWindow.fromWebContents(event.sender);
  if (win && !win.isDestroyed()) {
    win.hide();
  }
});

ipcMain.handle("show-from-tray", () => {
  if (mainWindow) {
    if (mainWindow.isVisible()) {
      mainWindow.focus();
    } else {
      mainWindow.show();
    }
  } else {
    createWindow();
  }
});

ipcMain.handle("is-tray-available", () => {
  return true; // 现代系统都支持托盘
});
```

### 2. 预加载脚本 (`main/preload.ts`)

```typescript
contextBridge.exposeInMainWorld('electronAPI', {
  // ... 其他API
  hideToTray: () => ipcRenderer.invoke('hide-to-tray'),
  showFromTray: () => ipcRenderer.invoke('show-from-tray'),
  isTrayAvailable: () => ipcRenderer.invoke('is-tray-available'),
  onOpenSettingsPage: (callback: () => void) => ipcRenderer.on('open-settings-page', callback),
  removeOpenSettingsPageListener: () => ipcRenderer.removeAllListeners('open-settings-page'),
});
```

### 3. 渲染进程状态管理

#### 托盘状态Hook (`renderer/src/hooks/useTrayState.ts`)
```typescript
export const useTrayState = (): [TrayState, TrayActions] => {
  const [state, setState] = useState<TrayState>({
    isTrayAvailable: false,
    isMinimizedToTray: false,
    isTrayInitialized: false,
  });

  const checkTrayAvailability = useCallback(async () => {
    try {
      const isAvailable = await window.electronAPI.isTrayAvailable();
      setState(prev => ({
        ...prev,
        isTrayAvailable: isAvailable,
        isTrayInitialized: true,
      }));
    } catch (error) {
      console.error('检查托盘可用性失败:', error);
      setState(prev => ({
        ...prev,
        isTrayAvailable: false,
        isTrayInitialized: true,
      }));
    }
  }, []);

  const hideToTray = useCallback(async () => {
    try {
      await window.electronAPI.hideToTray();
      setState(prev => ({
        ...prev,
        isMinimizedToTray: true,
      }));
    } catch (error) {
      console.error('隐藏到托盘失败:', error);
    }
  }, []);

  const showFromTray = useCallback(async () => {
    try {
      await window.electronAPI.showFromTray();
      setState(prev => ({
        ...prev,
        isMinimizedToTray: false,
      }));
    } catch (error) {
      console.error('从托盘显示失败:', error);
    }
  }, []);

  return [state, { hideToTray, showFromTray, checkTrayAvailability }];
};
```

#### 托盘Context (`renderer/src/contexts/TrayContext.tsx`)
```typescript
export const TrayProvider: React.FC<TrayProviderProps> = ({ children }) => {
  const [state, actions] = useTrayState();

  useEffect(() => {
    actions.checkTrayAvailability();
  }, [actions]);

  const contextValue: TrayContextType = {
    ...state,
    ...actions,
  };

  return (
    <TrayContext.Provider value={contextValue}>
      {children}
    </TrayContext.Provider>
  );
};
```

### 4. 组件集成

#### 标题栏组件 (`renderer/src/components/TitleBar.tsx`)
```typescript
const handleClose = async () => {
  if (isTrayAvailable) {
    await hideToTray();
  } else {
    window.electronAPI.windowClose();
  }
};
```

#### 主应用组件 (`renderer/src/components/MainApp.tsx`)
```typescript
export const MainApp: React.FC = () => {
  const handleOpenSettingsPage = useCallback(() => {
    navigate('/settings');
  }, [navigate]);

  useEffect(() => {
    window.electronAPI.onOpenSettingsPage(handleOpenSettingsPage);
    return () => {
      window.electronAPI.removeOpenSettingsPageListener();
    };
  }, [handleOpenSettingsPage]);

  return (
    <TrayProvider>
      <RouterProvider router={router} />
    </TrayProvider>
  );
};
```

## 关键技术要点

### 1. 图标处理
- **问题**: `nativeImage.createFromPath()` 不能直接处理SVG文件
- **解决方案**: 使用base64编码的PNG数据URL
- **优势**: 跨平台兼容性好，无需外部文件依赖

### 2. 窗口管理
- **策略**: 窗口关闭时隐藏到托盘而不是退出应用
- **实现**: 监听 `window-all-closed` 事件，在非macOS平台上阻止应用退出

### 3. IPC通信
- **模式**: 主进程处理托盘逻辑，渲染进程通过IPC控制
- **安全**: 使用 `contextBridge` 暴露安全的API接口

### 4. 状态管理
- **架构**: React Context + Custom Hook
- **优势**: 状态集中管理，组件解耦

### 5. 全局快捷键
- **集成**: 托盘菜单与全局快捷键功能统一
- **用户体验**: 提供多种方式访问应用功能

## 最佳实践

1. **错误处理**: 所有IPC调用都包含try-catch错误处理
2. **状态同步**: 托盘状态与窗口状态保持同步
3. **用户体验**: 提供多种方式访问应用功能（托盘菜单、全局快捷键、窗口操作）
4. **跨平台兼容**: 考虑不同操作系统的托盘行为差异

## 常见问题解决

### 托盘图标不显示
- **原因**: 图标格式不支持或路径错误
- **解决**: 使用base64编码的PNG数据URL

### 窗口关闭后应用退出
- **原因**: 没有正确处理 `window-all-closed` 事件
- **解决**: 在非macOS平台上阻止应用退出

### 托盘状态不同步
- **原因**: 状态管理不完整
- **解决**: 使用Context API统一管理状态

## 总结

系统托盘功能的实现涉及主进程、渲染进程、状态管理等多个方面。通过合理的架构设计和错误处理，可以提供一个稳定、用户友好的托盘体验。关键技术包括图标处理、窗口管理策略、IPC通信和状态管理等。
